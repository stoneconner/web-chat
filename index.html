<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"/>
    <script type="javascript" src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <style>
      body {
        padding-top: 50px;
        padding-bottom: 20px;
      }
      video{
        width:100%;
        height:100%;
      }
      #video-self{
        height:123px;
      }
      #video-self video{
        border:6px solid #4cae4c;
        border-radius:4px;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">WebRTC Video Call</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <form class="navbar-form navbar-right">
            <div class="form-group">
              <input id="tbx_phone" type="text" placeholder="Phone Number" class="form-control">
            </div>
            <button id="btn_call" type="button" style="display:none;" class="btn btn-success">Call</button>
          </form>
        </div>
      </div>
    </nav>
    <div class="jumbotron">
      <div class="row">
        <div id="content">
          <div id="video-out" class="container">
            <div id="video-self" class="col-xs-2 col-xs-offset-5">
            </div>
            <br/>
            <div id="callstreams" class="col-xs-12">

            </div>
          </div>
        </div>
      </div>
    </div>


    <!-- Libs and Scripts -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://cdn.pubnub.com/pubnub.min.js"></script>
    <script src="http://stephenlb.github.io/webrtc-sdk/js/webrtc.js"></script>
    <script>

    (function(){
      var img_self  = PUBNUB.$('video-self');

      /*START INIT*/
        var phone = PHONE({
            number        : '987',
            publish_key   : 'pub-c-26b27974-8a2a-4536-a310-d34b2878b8d9',
            subscribe_key : 'sub-c-ac72c74c-567b-11e5-81b5-02ee2ddab7fe',
            ssl           : true
        });
     /*END INIT*/

        // As soon as the phone is ready we can make calls
        phone.ready(function(){
            // Show camera stream and enable call button
            $("#video-self").append(phone.video);
            $("#btn_call").fadeIn();

        });
        var sessions = [];

        $("#btn_call").click(function(){
          var phone_number = $("#tbx_phone").val();
          if(sessions.length>0){
            //Check sessions to see if number is currently connected
            sessions.forEach(function(user){
              if(user.number == phone_number){
                //ignore call if connected
              }else{
                sessions.push(phone.dial(phone_number));
              }
            });
          }else{
            sessions.push(phone.dial(phone_number));
          }
        });

        // When Call Comes In or is to be Connected
        phone.receive(function(session){
            // Display partner's video

            sessions.forEach(function(friend){
                friend.connected(function(session){
                  var sessid = session.number;
                  $("#callstreams").append("<div id='"+sessid+"' class='col-xs-3' style='overflow:hidden;border:2px solid #444;border-radius:4px;background:#444;'></div>")
                  $('#'+sessid).append(session.video);
                });

                friend.ended(function(session){
                  //Remove user from our sessions when they disconnect 
                  var sessid = session.number;
                  sessions.forEach(function(user){
                    if(user.number == sessid){
                      var index = sessions.indexOf(user);
                      sessions.splice(index,1);
                    }
                  });
                  $('#'+sessid).fadeOut();
                });
            });

        });

    })();</script>
  </body>
</html>
